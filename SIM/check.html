<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>库云平台SIM卡流量查询</title>
	<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>

<div style="padding: 100px 100px 10px;">
	<form class="bs-example bs-example-form" role="form">
		<div class="row">
			<div class="col-lg-6">
				<div class="input-group">
          <input id="number" type="text" class="form-control">
					<span class="input-group-btn">
						<button id="check" class="btn btn-default" type="button">
							  查询
						</button>
					</span>
				</div><!-- /input-group -->
			</div><!-- /.col-lg-6 --><br>
			<div class="col-lg-12" >

				  当前流量

				<label id="usage" style="padding:20px 20px 20px"/>
			</div><!-- /.col-lg-6 -->
		</div><!-- /.row -->
	</form>
</div>

</body>
<script>
	var hastoken = 1;
	$(document).ready(function(){
			login(hastoken,function(result){
					if(result.code == 200){
						console.log('callback',result.hastoken);
						hastoken = result.hastoken;
					}else if(result.code == 505){
						alert('同时在线的终端数过多，请1小时后再试');
						hastoken = 0;
					}
			})
	});
	$('#check').click(function(){
		console.log($('#number').val());
		if(!$('#number').val()){
			alert('请输入要查询的sim卡号');
		}else{
		    if(hastoken == 1){
				checkUsage($('#number').val());
			}else{
				alert('您没有查询的权限');
			}
		}
	});

	function login(hastoken,callback){
		var settings = {
		  "async": true,
		  "crossDomain": true,
		  "url": "http://kuyun.coderise.cn:3000/api/access_token/",
		  "method": "POST",
		  "headers": {
		    "accept": "application/json",
		    "content-type": "application/x-www-form-urlencoded",
		  },
		  "data": {
		    "username": "szcoderise",
		    "password": "123123",
				"hastoken": hastoken
		  }
		}
		$.ajax(settings).done(function (response) {
		  console.log(response);
			callback(response);
		});
	}

	function checkUsage(id){
		var settings = {
		  "async": true,
		  "crossDomain": true,
		  "url": "http://kuyun.coderise.cn:3000/api/card/",
		  "method": "GET",
			"data": {
		    "id": id,
		  }
		}

		$.ajax(settings).done(function (response) {
		  var temp = JSON.parse(response)
			if(temp.code == 200){
				$('#usage').html(temp.data_usage+' M');
			}else if(temp.code == 502){
				$('#usage').html(temp.msg);
			}else if(temp.code == 403){
				$('#usage').html('登录验证已过期，请刷新重试');
				hastoken = 0;
				login(hastoken,function(result){
						if(result.code == 200){
							hastoken = result.hastoken;
						}else if(result.code == 505){
							alert('同时在线的终端数过多，请1小时后再试');
						}
				})
			}else if(temp.code == 402){
				$('#usage').html('token错误，请刷新重试');
				hastoken = 0;
				login(hastoken,function(result){
						if(result.code == 200){
							hastoken = result.hastoken;
						}else if(result.code == 505){
							alert('同时在线的终端数过多，请1小时后再试');
						}
				})
			}else{
				$('#usage').html(temp.msg);
			}
		});
	}
</script>
</html>
